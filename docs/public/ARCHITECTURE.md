# ToonForge System Architecture

## 🏗️ Overview

ToonForge는 언리얼 엔진 5의 렌더링 파이프라인에 통합되는 NPR(Non-Photorealistic Rendering) 플러그인입니다.

### 핵심 설계 원칙
- **모듈화**: 각 NPR 효과는 독립적으로 동작
- **성능 우선**: 실시간 렌더링에 최적화
- **확장성**: 새로운 효과를 쉽게 추가
- **사용성**: 아티스트가 쉽게 사용할 수 있는 인터페이스

---

## 📦 플러그인 구조

```
ToonForge Plugin
├── 📁 Runtime Module (게임 실행 시 사용)
│   ├── NPR 효과들 (툰 셰이딩, 아웃라인, 수채화)
│   ├── 렌더링 파이프라인
│   └── 성능 모니터링
│
├── 📁 Editor Module (에디터에서만 사용)
│   ├── NPR 제어 패널
│   ├── 프리셋 관리
│   └── 실시간 프리뷰
│
└── 📁 Shaders (셰이더 파일들)
    ├── 툰 셰이딩 셰이더
    ├── 아웃라인 셰이더
    └── 수채화 셰이더
```

---

## 🔄 렌더링 파이프라인 통합

### 언리얼 엔진 5 렌더링 순서
```
1. 3D 씬 렌더링 (메시, 라이팅 등)
2. 포스트 프로세싱 시작
   ├── 기본 포스트 효과들
   ├── 🎨 ToonForge NPR 효과들 ← 여기서 실행!
   └── 최종 화면 출력
3. UI 렌더링
```

### ToonForge NPR 효과 순서
```
입력: 원본 3D 렌더링 결과
  ↓
1. 툰 셰이딩 (색상 단계화)
  ↓  
2. 아웃라인 렌더링 (윤곽선 추가)
  ↓
3. 수채화 효과 (질감 추가)
  ↓
출력: NPR 스타일 최종 이미지
```

---

## 🧩 핵심 시스템

### 1. NPR 효과 관리자
**역할**: 모든 NPR 효과를 관리하고 실행 순서 제어

```
FToonForgeManager
├── 효과 등록/해제
├── 전체 NPR 켜기/끄기
├── 성능 모니터링
└── 자동 품질 조정
```

### 2. 개별 NPR 효과들
**각 효과는 독립적으로 동작**

```
📋 INPREffect (공통 인터페이스)
├── 🎭 툰 셰이딩 효과
│   ├── 색상 단계 수 (3-8단계)
│   ├── 그림자 강도
│   └── 하이라이트 설정
│
├── 🖼️ 아웃라인 효과  
│   ├── 두께 조정
│   ├── 색상 설정
│   └── 검출 방식 (깊이/법선)
│
└── 🎨 수채화 효과
    ├── 노이즈 강도
    ├── 색상 번짐
    └── 종이 질감
```

### 3. 성능 모니터링
**실시간으로 성능 추적 및 최적화**

```
FNPRPerformanceMonitor
├── GPU 시간 측정 (각 효과별)
├── 메모리 사용량 추적
├── FPS 모니터링
└── 자동 품질 조정
```

### 4. 프리셋 시스템
**NPR 스타일을 저장하고 불러오기**

```
FNPRPresetManager
├── 프리셋 저장/로드 (JSON 파일)
├── 기본 프리셋 제공
│   ├── 애니메이션 스타일
│   ├── 만화책 스타일
│   └── 수채화 스타일
└── 사용자 커스텀 프리셋
```

---

## 📊 데이터 흐름

### 초기화 과정
```
1. 플러그인 시작
2. NPR 효과들 등록
3. 렌더링 파이프라인에 연결
4. 기본 프리셋 로드
5. 사용 준비 완료
```

### 매 프레임 렌더링
```
1. 성능 측정 시작
2. 활성화된 NPR 효과들 순차 실행
   ├── 툰 셰이딩 (활성화 시)
   ├── 아웃라인 (활성화 시)  
   └── 수채화 (활성화 시)
3. 성능 측정 종료
4. 필요시 품질 자동 조정
```

### 사용자 입력 처리
```
사용자 입력 (키보드/UI)
  ↓
파라미터 검증
  ↓
해당 NPR 효과 업데이트
  ↓
즉시 화면에 반영
```

---

## ⚡ 성능 최적화

### 메모리 관리
- **렌더 타겟 풀링**: 메모리 재사용으로 할당 비용 절약
- **자동 정리**: 사용하지 않는 리소스 자동 해제

### GPU 최적화  
- **배치 처리**: 비슷한 오브젝트들 한 번에 처리
- **LOD 시스템**: 거리에 따른 품질 조정
- **셰이더 최적화**: 불필요한 계산 제거

### 자동 품질 조정
```
목표 FPS 설정 (예: 60 FPS)
  ↓
현재 성능이 목표보다 낮으면
  ↓
자동으로 NPR 품질 낮춤
  ↓
성능 여유가 생기면 품질 다시 높임
```

---

## 🔧 확장성

### 새로운 NPR 효과 추가하기
1. **INPREffect 인터페이스 구현**
2. **전용 셰이더 작성**  
3. **매니저에 효과 등록**
4. **에디터 UI 추가** (선택사항)

### 플랫폼 확장
- **PC**: 고품질 NPR 효과
- **모바일**: 최적화된 경량 버전
- **콘솔**: 플랫폼별 최적화

---

## 🛡️ 안정성

### 에러 처리
- **안전한 포인터 사용**: 크래시 방지
- **리소스 생명주기 관리**: 메모리 누수 방지
- **예외 상황 대응**: 견고한 코드

### 스레드 안전성
- **렌더 스레드**: 모든 렌더링 작업은 렌더 스레드에서 실행
- **게임 스레드**: UI 및 사용자 입력 처리
- **안전한 데이터 교환**: 스레드 간 안전한 통신

---

## 🎯 핵심 장점

### 개발자 관점
- **모듈화된 구조**: 유지보수 용이
- **성능 투명성**: 각 효과의 비용 명확히 표시
- **확장 가능**: 새로운 효과 쉽게 추가

### 아티스트 관점  
- **즉시 피드백**: 파라미터 변경 시 실시간 반영
- **직관적 UI**: 복잡한 기술 지식 불필요
- **프리셋 시스템**: 스타일 저장 및 공유

### 성능 관점
- **실시간 렌더링**: 60 FPS 유지 가능
- **자동 최적화**: 목표 성능에 맞춰 품질 조정
- **메모리 효율성**: 최소한의 메모리 사용

---

이 아키텍처는 **단순함과 확장성의 균형**을 맞춰 실제 게임 개발에서 사용할 수 있는 견고한 NPR 시스템을 제공합니다.
